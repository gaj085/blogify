<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('./partials/head') %>
    <title>
      <%= blog.title %>
    </title>
</head>

<body>

  <%- include('./partials/nav') %>

    <div class="container py-5">

      <!-- ================= Blog Header ================= -->
      <h1 class="fw-bold mb-3">
        <%= blog.title %>
      </h1>

      <div class="d-flex align-items-center mb-3">
        <img src="<%= blog.createdBy.profileImageURL %>" class="rounded-circle me-2" width="40" height="40"
          style="object-fit: contain;">

        <span class="fw-semibold">
          <%= blog.createdBy.fullName %>
        </span>

        <span class="text-muted small ms-2">
          â€¢ <%= blog.createdAt.toDateString() %>
        </span>
      </div>

      <!-- Author Controls -->
      <% if (user && blog.createdBy._id.equals(user._id)) { %>
        <div class="mb-3">
          <a href="/blog/edit/<%= blog._id %>" class="btn btn-sm btn-outline-primary me-2">
            Edit
          </a>

          <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteBlogModal">
            Delete
          </button>
        </div>
        <% } %>

          <!-- ================= Blog Image ================= -->
          <div class="my-4">
            <img src="<%= blog.coverImageURL %>" class="img-fluid rounded shadow-sm"
              style="max-height: 500px; width: 100%; object-fit: cover;">
          </div>

          <!-- ================= Blog Content ================= -->
          <div class="mb-5">
            <p style="white-space: pre-wrap;" class="fs-5 lh-lg">
              <%= blog.body %>
            </p>
          </div>

          <hr class="my-5">

          <!-- ================= Comments Section ================= -->
          <h4 class="fw-bold mb-4">
            Comments (<%= comments.length %>)
          </h4>

          <!-- Add Comment -->
          <% if (user) { %>
            <form action="/blog/comment/<%= blog._id %>" method="post" class="mb-4">

              <div class="mb-2">
                <textarea name="content" class="form-control" rows="3" placeholder="Write your comment..."
                  required></textarea>
              </div>

              <button class="btn btn-dark btn-sm">
                Post Comment
              </button>
            </form>
            <% } %>

              <!-- Comment List -->
              <% comments.forEach(comment=> { %>

                <div class="card mb-3 border-0 shadow-sm">
                  <div class="card-body">

                    <div class="d-flex align-items-center mb-2">

                      <img src="<%= comment.createdBy.profileImageURL %>" class="rounded-circle me-2" width="35"
                        height="35" style="object-fit: contain;">

                      <span class="fw-semibold">
                        <%= comment.createdBy.fullName %>
                      </span>

                      <% if (comment.createdBy._id.equals(blog.createdBy._id)) { %>
                        <span class="badge bg-primary ms-2">
                          Author
                        </span>
                        <% } %>

                          <span class="text-muted small ms-auto">
                            <%= comment.createdAt.toDateString() %>
                          </span>

                    </div>

                    <p style="white-space: pre-wrap;">
                      <%= comment.content %>
                    </p>

                    <!-- Comment Delete Control -->
                    <% if (user && (comment.createdBy._id.equals(user._id) || blog.createdBy._id.equals(user._id))) { %>

                      <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                        data-bs-target="#deleteCommentModal" data-comment-id="<%= comment._id %>">
                        Delete
                      </button>

                      <% } %>

                  </div>
                </div>

                <% }) %>

    </div>


    <!-- ================= Delete Blog Modal ================= -->

    <div class="modal fade" id="deleteBlogModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Delete Blog</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            Are you sure you want to delete this blog?
            This action cannot be undone.
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>

            <form action="/blog/delete/<%= blog._id %>" method="post">
              <button class="btn btn-danger">
                Yes, Delete
              </button>
            </form>
          </div>

        </div>
      </div>
    </div>


    <!-- ================= Delete Comment Modal ================= -->

    <div class="modal fade" id="deleteCommentModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Delete Comment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            Are you sure you want to delete this comment?
          </div>

          <div class="modal-footer">

            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>

            <form id="deleteCommentForm" method="post">
              <button class="btn btn-danger">
                Yes, Delete
              </button>
            </form>

          </div>

        </div>
      </div>
    </div>


    <!-- ================= Modal Script ================= -->

    <script>
      const deleteCommentModal = document.getElementById('deleteCommentModal');

      deleteCommentModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const commentId = button.getAttribute('data-comment-id');

        const form = document.getElementById('deleteCommentForm');
        form.action = `/blog/comment/delete/${commentId}`;
      });
    </script>

    <%- include('./partials/scripts') %>

</body>

</html>